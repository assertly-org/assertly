
const Postgres = require('./postgres');
const Elasticsearch = require('./elasticsearch');
const Redis = require('./redis');

/*
  Set up I/O connections to external systems
 */
module.exports = function () {

  let connections = [];

  // TODO move connectors from lib/middleware/index.js to here
  //   waiting for mp-ui-services refactor before starting this or major merge conflicts and delays
  //   app will also be replaced by just passing the config
  exports.initConnections = async (app) => {

    const postgres = new Postgres(app);
    const elasticsearch = new Elasticsearch(app);
    const redis = new Redis(app);

    connections = [postgres, elasticsearch, redis];
    const connectionPromises = connections.map(conn => conn.init());

    // app requires all connections to complete initialization before handling requests
    await Promise.all(connectionPromises);

    return connections;
  };

  exports.smokeTest = async (req, res) => {

    const connectorSmokeTests = connections.map(conn => conn.smokeTest());

    await Promise.all(connectorSmokeTests);
    res.sendStatus(200);
  };

  return exports;
};