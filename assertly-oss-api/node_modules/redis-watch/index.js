"use strict";

const heartbeats = require('heartbeats');
const uuid = require('node-uuid');
const Redis = require('ioredis');

let heart = heartbeats.createHeart(1000);
let inProgress = {};

function monitor(redis) {

  let launchEvent = heart.createEvent(10,function(hb,last) {
    let testUUID = uuid.v4();

    inProgress[testUUID] = true;

    redis.set(testUUID,true);
    redis.get(testUUID,function(err,value) {
      if(!err && value) delete inProgress[testUUID];
    });

    let testEvent = heart.createEvent(3,{ repeat: 1 },function(hb,last) {
       if(inProgress[testUUID]) {
         console.log(`Error: redis test timeout ${testUUID} still in progress after 3 seconds`);
         delete inProgress[testUUID];
       }
    });
  });
}

module.exports = function(args) {
  args.dropBufferSupport = true;  
  let redis = new Redis(args);

  redis.on("error",function(err) {
    let msg = `Error: redis error: ${err}`
    console.log(msg);
  });

  return { 
    monitor:function() { monitor(redis); }
  }
}
